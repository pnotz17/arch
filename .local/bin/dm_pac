#!/usr/bin/env bash

# script name: dm-pacman
# Description: A software manager using dmenu
# Dependencies: dmenu, pacman
# Contributors: Murtaza Udaipurwala
#               HostGrady

TERMINAL="st"
packageList="$HOME/.cache/packageList"

refresh(){
    # only update the packageList once a day
    [ "$(stat -c %y "$packageList" 2>/dev/null | cut -d' ' -f1)" != "$(date '+%Y-%m-%d')" ] &&
        pacman -Si |
        awk '/^Name/{name=$3} /^Description/{sub(/^.{18}/,"", $0); print name, " => ", $0}' > "$HOME"/.cache/packageList
}

confirm(){
    answer=$(printf "No\nYes" | dmenu -c -g 1 -p "$1") || exit
    [ "$answer" = "No" ] && exit
}

install(){
    refresh
    package=$(dmenu -c -g 1 -p "Package to install" < "$packageList") || exit
    confirm "Install this package?"
    $TERMINAL -e doas pacman -S --noconfirm $(echo "$package" | cut -d'=' -f1)
}

remove(){
    package=$(pacman -Qeq | dmenu -c -g 1 -p "Package to remove") || exit
    confirm "Remove this package?"
    $TERMINAL doas pacman -Rns --noconfirm "$package"
}

update(){
    confirm "Update the system?"
    $TERMINAL -e doas pacman -Syu --noconfirm
}

cleanUp(){
    [ "$(pacman -Qdtq)" = "" ] && exit
    $TERMINAL -e doas pacman -Rns --noconfirm $(pacman -Qdtq)
}

menu(){
    operation=$(printf "Install\nRemove\nUpdate\nRemove orphans" | dmenu -c -g 1 -p "operation:") || exit
    case $operation in
        "Install") install ;;
        "Remove") remove ;;
        "Update") update ;;
        "Remove orphans") cleanUp ;;
        *) echo "invalid operation" && exit ;;
    esac
}

menu
